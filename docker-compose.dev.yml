# =============================================================================
# PyRest Dev Environment (standalone — no IDE required)
# =============================================================================
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up -d --build   # Build & start
#   docker-compose -f docker-compose.dev.yml exec dev bash    # Open shell
#   docker-compose -f docker-compose.dev.yml logs -f dev      # View logs
#   docker-compose -f docker-compose.dev.yml down             # Stop
#
# This creates the same environment as the Dev Container (.devcontainer/)
# but without Cursor/VS Code integration.  Code lives INSIDE the container
# (no bind mounts), so there are no Windows/Linux permission issues.
#
# To persist code changes between rebuilds, use `docker cp` or commit to git
# from inside the container.
#
# Access:
#   Nginx proxy:  http://localhost:8080/pyrest/
#   PyRest API:   http://localhost:8000/pyrest/
#   Admin UI:     http://localhost:8000/pyrest/admin/
# =============================================================================

version: '3.8'

services:
  dev:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    container_name: pyrest-dev
    restart: unless-stopped
    ports:
      - "8080:8080"   # Nginx
      - "8000:8000"   # PyRest main
      - "8001:8001"   # Isolated app 1
      - "8002:8002"   # Isolated app 2
      - "8003:8003"   # Isolated app 3
    environment:
      - PYREST_HOST=0.0.0.0
      - PYREST_PORT=8000
      - PYREST_DEBUG=true
      - PYREST_CLEAN_VENVS=false
    volumes:
      # Named volumes — no bind mounts, no permission issues
      - dev-logs:/app/logs
      - dev-venv-pov:/app/apps/pov/.venv
      - dev-venv-tm1data:/app/apps/tm1data/.venv
      - dev-venv-tm1query:/app/apps/tm1query/.venv
    # First-time: set up venvs, then start all services + keep alive
    command: >
      bash -c "
        bash .devcontainer/post-create.sh &&
        bash .devcontainer/post-start.sh &&
        python main.py --debug --no-isolated
      "
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/pyrest/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - pyrest-dev-network

networks:
  pyrest-dev-network:
    driver: bridge

volumes:
  dev-logs:
  dev-venv-pov:
  dev-venv-tm1data:
  dev-venv-tm1query:
