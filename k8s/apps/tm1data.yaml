# tm1data - TM1 Data Connector App
# Isolated app with KEDA scale-to-zero
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pyrest-tm1data
  namespace: pyrest
  labels:
    app: pyrest-tm1data
    app.kubernetes.io/name: pyrest-tm1data
    app.kubernetes.io/component: isolated-app
    app.kubernetes.io/part-of: pyrest
spec:
  replicas: 0
  selector:
    matchLabels:
      app: pyrest-tm1data
  template:
    metadata:
      labels:
        app: pyrest-tm1data
        app.kubernetes.io/name: pyrest-tm1data
        app.kubernetes.io/component: isolated-app
    spec:
      containers:
        - name: app
          # Replace with your ACR registry
          image: myregistry.azurecr.io/pyrest-tm1data:latest
          ports:
            - containerPort: 8001
              name: http
              protocol: TCP
          env:
            - name: PYREST_APP_NAME
              value: "tm1data"
            - name: PYREST_APP_PORT
              value: "8001"
            - name: PYREST_APP_PATH
              value: "/app/appdir"
            - name: PYREST_BASE_PATH
              value: "/pyrest"
            - name: PYREST_NUM_PROCESSES
              value: "4"
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /pyrest/tm1data/health
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /pyrest/tm1data/health
              port: 8001
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: pyrest-tm1data
  namespace: pyrest
  labels:
    app: pyrest-tm1data
    app.kubernetes.io/name: pyrest-tm1data
    app.kubernetes.io/component: isolated-app
    app.kubernetes.io/part-of: pyrest
spec:
  type: ClusterIP
  selector:
    app: pyrest-tm1data
  ports:
    - name: http
      port: 8001
      targetPort: 8001
      protocol: TCP
---
apiVersion: http.keda.sh/v1alpha1
kind: HTTPScaledObject
metadata:
  name: pyrest-tm1data
  namespace: pyrest
  labels:
    app: pyrest-tm1data
    app.kubernetes.io/part-of: pyrest
spec:
  hosts:
    - ""
  pathPrefixes:
    - /pyrest/tm1data
  scaleTargetRef:
    name: pyrest-tm1data
    service: pyrest-tm1data
    port: 8001
  replicas:
    min: 0
    max: 2
  scalingMetric:
    requestRate:
      targetValue: 10
  cooldownPeriod: 300
