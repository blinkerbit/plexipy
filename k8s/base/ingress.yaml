# PyRest Ingress
# Routes traffic by path prefix to the correct service.
# On AKS, this replaces the in-container Nginx reverse proxy.
#
# Prerequisites:
#   - Nginx Ingress Controller installed on the AKS cluster
#   - KEDA HTTP Add-on installed (for scale-to-zero apps)
#
# To add a new isolated app, add a new path rule pointing to its service.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pyrest-ingress
  namespace: pyrest
  labels:
    app.kubernetes.io/part-of: pyrest
  annotations:
    # Nginx Ingress Controller annotations
    nginx.ingress.kubernetes.io/rewrite-target: /$0
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    # Uncomment for TLS with cert-manager
    # cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  # Uncomment for TLS
  # tls:
  #   - hosts:
  #       - pyrest.yourdomain.com
  #     secretName: pyrest-tls
  rules:
    - http:
        paths:
          # ---------------------------------------------------------------
          # Isolated apps (KEDA-managed, scale-to-zero)
          # Add one path block per isolated app
          # ---------------------------------------------------------------
          - path: /pyrest/tm1data(/.*)?$
            pathType: ImplementationSpecific
            backend:
              service:
                name: pyrest-tm1data
                port:
                  number: 8001

          - path: /pyrest/tm1query(/.*)?$
            pathType: ImplementationSpecific
            backend:
              service:
                name: pyrest-tm1query
                port:
                  number: 8001

          - path: /pyrest/pov(/.*)?$
            pathType: ImplementationSpecific
            backend:
              service:
                name: pyrest-pov
                port:
                  number: 8001

          # ---------------------------------------------------------------
          # Main framework (catch-all for /pyrest/*)
          # Must be LAST so isolated app paths match first
          # ---------------------------------------------------------------
          - path: /pyrest(/.*)?$
            pathType: ImplementationSpecific
            backend:
              service:
                name: pyrest-main
                port:
                  number: 8000
