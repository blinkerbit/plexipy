# PyRest Main Framework Deployment
# Always runs 1 replica (not scaled by KEDA -- this is the core framework)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pyrest-main
  namespace: pyrest
  labels:
    app: pyrest-main
    app.kubernetes.io/name: pyrest-main
    app.kubernetes.io/component: framework
    app.kubernetes.io/part-of: pyrest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pyrest-main
  template:
    metadata:
      labels:
        app: pyrest-main
        app.kubernetes.io/name: pyrest-main
        app.kubernetes.io/component: framework
    spec:
      containers:
        - name: pyrest
          # Replace with your ACR registry path
          image: ${ACR_REGISTRY}/pyrest-main:latest
          ports:
            - containerPort: 8000
              name: http
              protocol: TCP
          env:
            - name: PYREST_HOST
              value: "0.0.0.0"
            - name: PYREST_PORT
              value: "8000"
            - name: PYREST_DEBUG
              value: "false"
            # Pass --no-isolated since isolated apps run as separate deployments on AKS
            - name: PYREST_NO_ISOLATED
              value: "true"
            # Uncomment for air-gapped environments
            # - name: PIP_INDEX_URL
            #   value: "https://pypi.internal.company.com/simple/"
            # - name: PIP_TRUSTED_HOST
            #   value: "pypi.internal.company.com"
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /pyrest/health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /pyrest/health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          volumeMounts:
            - name: config
              mountPath: /app/config.json
              subPath: config.json
              readOnly: true
            - name: auth-config
              mountPath: /app/auth_config.json
              subPath: auth_config.json
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: pyrest-config
        - name: auth-config
          secret:
            secretName: pyrest-auth-config
