<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyRest Admin</title>
    <style>
        :root {
            --bg: #002b36;
            --bg-alt: #073642;
            --fg: #93a1a1;
            --fg-dim: #586e75;
            --fg-bright: #eee8d5;
            --accent: #268bd2;
            --success: #859900;
            --warning: #b58900;
            --error: #dc322f;
            --cyan: #2aa198;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-alt);
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: normal;
            color: var(--fg-bright);
            letter-spacing: 0.05em;
        }
        h1 span { color: var(--fg-dim); }
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        .btn {
            background: var(--bg-alt);
            color: var(--fg);
            border: 1px solid var(--fg-dim);
            padding: 0.5rem 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn:hover {
            background: #0a4052;
            color: var(--fg-bright);
            border-color: var(--fg);
        }
        .btn.primary {
            border-color: var(--accent);
            color: var(--accent);
        }
        .btn.primary:hover {
            background: var(--accent);
            color: var(--bg);
        }
        .status-bar {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            background: var(--bg-alt);
            margin-bottom: 2rem;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            color: var(--fg-bright);
        }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--fg-dim);
        }
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--bg-alt);
            margin-bottom: 1.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--fg-dim);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
        }
        .tab:hover { color: var(--fg); }
        .tab.active {
            color: var(--fg-bright);
            border-bottom-color: var(--accent);
        }
        .panel { display: none; }
        .panel.active { display: block; }
        h2 {
            font-size: 0.75rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--fg-dim);
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        th {
            text-align: left;
            font-size: 0.7rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--fg-dim);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--bg-alt);
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--bg-alt);
            transition: background 0.15s ease;
            vertical-align: top;
        }
        tr:hover td { background: var(--bg-alt); }
        .badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }
        .badge.loaded { color: var(--success); border: 1px solid var(--success); }
        .badge.running { color: var(--success); border: 1px solid var(--success); }
        .badge.stopped { color: var(--warning); border: 1px solid var(--warning); }
        .badge.failed { color: var(--error); border: 1px solid var(--error); }
        .badge.embedded { color: var(--fg-dim); border: 1px solid var(--fg-dim); }
        .badge.isolated { color: var(--accent); border: 1px solid var(--accent); }
        .badge.healthy { color: var(--success); border: 1px solid var(--success); }
        .badge.unhealthy { color: var(--error); border: 1px solid var(--error); }
        .badge.checking { color: var(--fg-dim); border: 1px solid var(--fg-dim); }
        .health-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.4rem;
            vertical-align: middle;
        }
        .health-dot.green { background: var(--success); }
        .health-dot.red { background: var(--error); }
        .health-dot.gray { background: var(--fg-dim); }
        .health-dot.pulse { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .action-btn {
            background: none;
            border: 1px solid var(--fg-dim);
            color: var(--fg-dim);
            padding: 0.2rem 0.5rem;
            font-size: 0.65rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .action-btn:hover {
            border-color: var(--fg);
            color: var(--fg);
        }
        .action-btn.success:hover {
            border-color: var(--success);
            color: var(--success);
        }
        .action-btn.danger:hover {
            border-color: var(--error);
            color: var(--error);
        }
        .action-btn.warn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }
        .action-btn.primary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* Process tree & venv info */
        .proc-info {
            font-size: 0.7rem;
            margin-top: 0.3rem;
            color: var(--fg-dim);
        }
        .proc-info .pid { color: var(--cyan); }
        .proc-info .workers { color: var(--fg); }
        .venv-info {
            font-size: 0.7rem;
            color: var(--fg-dim);
        }
        .venv-info .venv-exists { color: var(--success); }
        .venv-info .venv-missing { color: var(--warning); }
        .venv-info .venv-invalid { color: var(--error); }
        /* Detail row (expandable) */
        .detail-row td {
            padding: 0.5rem 1rem;
            background: rgba(7, 54, 66, 0.8);
            border-bottom: 2px solid var(--bg-alt);
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .detail-item-label {
            color: var(--fg-dim);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .detail-item-value {
            color: var(--fg-bright);
            word-break: break-all;
        }
        .log-container {
            background: var(--bg-alt);
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .log-entry .time { color: var(--fg-dim); }
        .log-entry .level { margin: 0 0.5rem; }
        .log-entry .level.info { color: var(--accent); }
        .log-entry .level.warn { color: var(--warning); }
        .log-entry .level.error { color: var(--error); }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .config-item {
            background: var(--bg-alt);
            padding: 1rem;
        }
        .config-key {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--fg-dim);
            margin-bottom: 0.25rem;
        }
        .config-value {
            color: var(--fg-bright);
            word-break: break-all;
        }
        .empty {
            text-align: center;
            padding: 3rem;
            color: var(--fg-dim);
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--fg-dim);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-alt);
            border: 1px solid var(--fg-dim);
            padding: 1rem 1.5rem;
            opacity: 0;
            transform: translateY(1rem);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
            max-width: 400px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        /* Confirm dialog */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: var(--bg-alt);
            border: 1px solid var(--fg-dim);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        }
        .modal-box h3 {
            color: var(--fg-bright);
            font-size: 1rem;
            font-weight: normal;
            margin-bottom: 1rem;
        }
        .modal-box p {
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }
        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="fade-in">
            <h1>PyRest <span>/ admin</span></h1>
            <div class="header-actions">
                <button class="btn" onclick="refreshData()">Refresh</button>
                <a href="/pyrest" class="btn">Back to Home</a>
            </div>
        </header>

        <div class="status-bar fade-in" id="status-bar">
            <div class="stat">
                <div class="stat-value" id="framework-health">-</div>
                <div class="stat-label">Framework</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-apps">-</div>
                <div class="stat-label">Total Apps</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="embedded-count">-</div>
                <div class="stat-label">Embedded</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="isolated-count">-</div>
                <div class="stat-label">Isolated</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="healthy-count">-</div>
                <div class="stat-label">Healthy</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="failed-count">-</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div class="tabs fade-in">
            <button class="tab active" data-panel="apps">Applications</button>
            <button class="tab" data-panel="config">Configuration</button>
            <button class="tab" data-panel="logs">Logs</button>
        </div>

        <div id="apps" class="panel active fade-in">
            <table id="apps-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status / Processes</th>
                        <th>Venv</th>
                        <th>Health</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="apps-tbody">
                    <tr><td colspan="6" class="empty"><span class="spinner"></span> Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="config" class="panel fade-in">
            <h2>Framework Configuration</h2>
            <div class="config-grid" id="config-grid">
                <div class="empty"><span class="spinner"></span> Loading...</div>
            </div>
        </div>

        <div id="logs" class="panel fade-in">
            <h2>Recent Activity</h2>
            <div class="log-container" id="log-container">
                <div class="empty">No logs available</div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Confirm dialog -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h3 id="confirm-title">Confirm</h3>
            <p id="confirm-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeConfirm()">Cancel</button>
                <button class="btn primary" id="confirm-btn" onclick="doConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        var API_BASE = '/pyrest/admin/api';
        var logs = [];
        var healthCache = {};
        var pendingConfirmAction = null;

        // =====================================================================
        // Tab switching
        // =====================================================================
        document.querySelectorAll('.tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        // =====================================================================
        // Toast & Logging
        // =====================================================================
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || '') + ' show';
            setTimeout(function() { toast.classList.remove('show'); }, 4000);
        }

        function addLog(level, message) {
            var now = new Date().toLocaleTimeString();
            logs.unshift({ time: now, level: level, message: message });
            if (logs.length > 100) logs.pop();
            renderLogs();
        }

        function renderLogs() {
            var container = document.getElementById('log-container');
            if (logs.length === 0) {
                container.innerHTML = '<div class="empty">No logs available</div>';
                return;
            }
            container.innerHTML = logs.map(function(log) {
                return '<div class="log-entry">' +
                    '<span class="time">' + log.time + '</span>' +
                    '<span class="level ' + log.level + '">[' + log.level.toUpperCase() + ']</span>' +
                    '<span class="msg">' + log.message + '</span>' +
                    '</div>';
            }).join('');
        }

        // =====================================================================
        // Confirm dialog
        // =====================================================================
        function showConfirm(title, message, action) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            pendingConfirmAction = action;
            document.getElementById('confirm-modal').classList.add('show');
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.remove('show');
            pendingConfirmAction = null;
        }

        function doConfirm() {
            var action = pendingConfirmAction;
            closeConfirm();
            if (action) action();
        }

        // =====================================================================
        // Health Check
        // =====================================================================
        function checkHealth(url, timeout) {
            timeout = timeout || 3000;
            return new Promise(function(resolve) {
                var controller = new AbortController();
                var timer = setTimeout(function() {
                    controller.abort();
                    resolve({ healthy: false, error: 'timeout', latency: timeout });
                }, timeout);

                var start = Date.now();
                fetch(url, { signal: controller.signal })
                    .then(function(r) {
                        clearTimeout(timer);
                        var latency = Date.now() - start;
                        if (r.ok) {
                            return r.json().then(function(data) {
                                resolve({ healthy: true, latency: latency, data: data });
                            }).catch(function() {
                                resolve({ healthy: true, latency: latency, data: {} });
                            });
                        } else {
                            resolve({ healthy: false, error: 'HTTP ' + r.status, latency: latency });
                        }
                    })
                    .catch(function(e) {
                        clearTimeout(timer);
                        var latency = Date.now() - start;
                        resolve({ healthy: false, error: e.message, latency: latency });
                    });
            });
        }

        function healthBadge(result) {
            if (!result) {
                return '<span class="health-dot gray pulse"></span><span class="badge checking">...</span>';
            }
            if (result.healthy) {
                return '<span class="health-dot green"></span><span class="badge healthy">' + result.latency + 'ms</span>';
            }
            return '<span class="health-dot red"></span><span class="badge unhealthy" title="' + (result.error || 'unreachable') + '">down</span>';
        }

        // =====================================================================
        // Data Loading
        // =====================================================================
        function refreshData() {
            healthCache = {};
            loadStatus();
            loadConfig();
            addLog('info', 'Data refreshed');
            showToast('Data refreshed', 'success');
        }

        function loadStatus() {
            // Check framework health
            checkHealth('/pyrest/health').then(function(result) {
                var el = document.getElementById('framework-health');
                if (result.healthy) {
                    el.innerHTML = '<span style="color: var(--success);">OK</span>';
                } else {
                    el.innerHTML = '<span style="color: var(--error);">DOWN</span>';
                }
            });

            // Load app status from admin API
            fetch(API_BASE + '/status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) renderStatus(data.data);
                })
                .catch(function(e) {
                    addLog('error', 'Failed to load status: ' + e.message);
                });
        }

        // =====================================================================
        // Render helpers
        // =====================================================================
        function renderProcessInfo(proc, name) {
            if (!proc || !proc.running) {
                return '<span class="proc-info">not running</span>';
            }
            var html = '<div class="proc-info" style="cursor:pointer;" onclick="refreshProcesses(\'' + name + '\')" title="Click to refresh">';
            html += 'PID <span class="pid">' + proc.pid + '</span>';
            var total = proc.total_processes || 1;
            var children = proc.child_pids || [];
            if (children.length > 0) {
                html += ' + <span class="workers">' + children.length + ' workers</span>';
                html += '<br><span style="color:var(--fg-dim);font-size:0.6rem;">' + children.join(', ') + '</span>';
            }
            html += ' <span style="color:var(--fg-dim);">(' + total + ' total)</span>';
            html += '</div>';
            return html;
        }

        function renderVenvInfo(venv, name) {
            if (!venv) return '<span class="venv-info venv-missing">-</span>';
            var html = '<div class="venv-info" style="cursor:pointer;" onclick="refreshVenvStatus(\'' + name + '\')" title="Click to refresh">';
            if (!venv.exists) {
                html += '<span class="venv-missing">no .venv</span>';
            } else if (!venv.valid) {
                html += '<span class="venv-invalid">invalid</span>';
            } else {
                html += '<span class="venv-exists">ready</span>';
                if (venv.size_mb !== null && venv.size_mb !== undefined) {
                    html += ' <span style="color:var(--fg-dim);">(' + venv.size_mb + ' MB)</span>';
                }
            }
            html += '</div>';
            return html;
        }

        function renderIsolatedActions(name, isRunning, venv) {
            var venvExists = venv && venv.exists;
            var venvValid = venv && venv.valid;

            // Row 1: App lifecycle
            var html = '<div class="actions" style="margin-bottom:0.3rem;">';
            html += '<button class="action-btn success" onclick="controlApp(\'' + name + '\', \'start\')"' +
                (isRunning ? ' disabled title="Already running"' : '') + '>Start</button>';
            html += '<button class="action-btn danger" onclick="controlApp(\'' + name + '\', \'stop\')"' +
                (!isRunning ? ' disabled title="Not running"' : '') + '>Stop</button>';
            html += '<button class="action-btn" onclick="controlApp(\'' + name + '\', \'restart\')"' +
                (!isRunning ? ' disabled title="Not running"' : '') + '>Restart</button>';
            html += '</div>';

            // Row 2: Venv lifecycle
            html += '<div class="actions">';
            html += '<button class="action-btn success" onclick="confirmCreateVenv(\'' + name + '\')"' +
                (venvExists ? ' disabled title=".venv already exists"' : '') + '>Create .venv</button>';
            html += '<button class="action-btn danger" onclick="confirmDeleteVenv(\'' + name + '\')"' +
                (!venvExists ? ' disabled title="No .venv to delete"' : '') + '>Delete .venv</button>';
            html += '<button class="action-btn primary" onclick="confirmRebuild(\'' + name + '\')">Rebuild .venv</button>';
            html += '</div>';
            return html;
        }

        // =====================================================================
        // Render status
        // =====================================================================
        function renderStatus(data) {
            var embedded = data.apps.embedded || [];
            var isolated = data.apps.isolated || [];
            var failed = data.apps.failed || [];

            document.getElementById('total-apps').textContent = embedded.length + isolated.length;
            document.getElementById('embedded-count').textContent = embedded.length;
            document.getElementById('isolated-count').textContent = isolated.length;
            document.getElementById('failed-count').textContent = failed.length;
            document.getElementById('healthy-count').innerHTML = '<span class="spinner" style="width:12px;height:12px;"></span>';

            var tbody = document.getElementById('apps-tbody');
            var rows = [];
            var allApps = [];

            // Embedded apps
            embedded.forEach(function(app) {
                var healthId = 'health-' + app.name;
                allApps.push({ name: app.name, prefix: app.prefix, type: 'embedded' });

                rows.push('<tr>' +
                    '<td><strong>' + app.name + '</strong><br><span style="color:var(--fg-dim);font-size:0.7rem;">' + app.prefix + '</span></td>' +
                    '<td><span class="badge embedded">embedded</span></td>' +
                    '<td><span class="badge loaded">loaded</span></td>' +
                    '<td>-</td>' +
                    '<td id="' + healthId + '">' + healthBadge(null) + '</td>' +
                    '<td>-</td>' +
                    '</tr>');
            });

            // Isolated apps
            isolated.forEach(function(app) {
                var isRunning = false;
                var proc = app.process || null;
                if (proc && proc.running) {
                    isRunning = true;
                } else if (app.running === true) {
                    isRunning = true;
                }

                var statusBadge = isRunning ?
                    '<span class="badge running">running</span>' :
                    '<span class="badge stopped">stopped</span>';

                var healthId = 'health-' + app.name;
                allApps.push({ name: app.name, prefix: app.prefix, type: 'isolated', port: app.port });

                rows.push('<tr>' +
                    '<td><strong>' + app.name + '</strong>' +
                        '<br><span style="color:var(--fg-dim);font-size:0.7rem;">' + app.prefix + ' :' + app.port + '</span></td>' +
                    '<td><span class="badge isolated">isolated</span></td>' +
                    '<td>' + statusBadge + renderProcessInfo(proc, app.name) + '</td>' +
                    '<td>' + renderVenvInfo(app.venv, app.name) + '</td>' +
                    '<td id="' + healthId + '">' + healthBadge(null) + '</td>' +
                    '<td>' + renderIsolatedActions(app.name, isRunning, app.venv) + '</td>' +
                    '</tr>');
            });

            // Failed apps
            failed.forEach(function(app) {
                var errShort = (app.error || 'Error').substring(0, 60);
                rows.push('<tr>' +
                    '<td><strong>' + app.name + '</strong></td>' +
                    '<td><span class="badge ' + (app.isolated ? 'isolated' : 'embedded') + '">' + (app.isolated ? 'isolated' : 'embedded') + '</span></td>' +
                    '<td><span class="badge failed">failed</span><div class="proc-info" title="' + (app.error || '') + '">' + errShort + '</div></td>' +
                    '<td>-</td>' +
                    '<td><span class="health-dot red"></span><span class="badge unhealthy">error</span></td>' +
                    '<td>-</td>' +
                    '</tr>');
            });

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No applications</td></tr>';
            } else {
                tbody.innerHTML = rows.join('');
            }

            // Ping each app's health endpoint
            var healthyCount = 0;
            var checkedCount = 0;
            var totalToCheck = allApps.length;

            allApps.forEach(function(app) {
                checkHealth(app.prefix + '/health').then(function(result) {
                    healthCache[app.name] = result;
                    checkedCount++;

                    var cell = document.getElementById('health-' + app.name);
                    if (cell) cell.innerHTML = healthBadge(result);

                    if (result.healthy) healthyCount++;

                    if (checkedCount >= totalToCheck) {
                        var countEl = document.getElementById('healthy-count');
                        countEl.textContent = healthyCount + '/' + totalToCheck;
                        countEl.style.color = healthyCount === totalToCheck ? 'var(--success)' :
                            (healthyCount > 0 ? 'var(--warning)' : 'var(--error)');
                    }
                });
            });

            if (totalToCheck === 0) {
                document.getElementById('healthy-count').textContent = '0';
            }
        }

        // =====================================================================
        // Config
        // =====================================================================
        function loadConfig() {
            fetch(API_BASE + '/config')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) renderConfig(data.data);
                })
                .catch(function(e) {
                    addLog('error', 'Failed to load config: ' + e.message);
                });
        }

        function renderConfig(data) {
            var grid = document.getElementById('config-grid');
            var items = [];
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    var value = data[key];
                    if (typeof value === 'object') value = JSON.stringify(value);
                    items.push('<div class="config-item">' +
                        '<div class="config-key">' + key + '</div>' +
                        '<div class="config-value">' + value + '</div>' +
                        '</div>');
                }
            }
            grid.innerHTML = items.join('') || '<div class="empty">No configuration data</div>';
        }

        // =====================================================================
        // App control
        // =====================================================================
        function controlApp(name, action) {
            addLog('info', 'Sending ' + action + ' to ' + name + '...');
            showToast(action + ' ' + name + '...', '');

            fetch(API_BASE + '/apps/' + name + '/' + action, { method: 'POST' })
                .then(function(r) {
                    if (r.status === 401 || r.status === 403) {
                        showToast('Authorization required. Please log in first.', 'error');
                        addLog('error', name + ' ' + action + ': not authorized (HTTP ' + r.status + ')');
                        return null;
                    }
                    return r.json();
                })
                .then(function(data) {
                    if (!data) return; // auth error already handled
                    if (data.success) {
                        var msg = data.message || (action + ' successful');
                        showToast(msg, 'success');
                        addLog('info', name + ': ' + msg);

                        // Log extra details
                        if (data.data) {
                            if (data.data.killed_pids) {
                                addLog('info', name + ': killed PIDs: ' + data.data.killed_pids.join(', '));
                            }
                            if (data.data.steps) {
                                addLog('info', name + ': steps: ' + data.data.steps.join(' -> '));
                            }
                            if (data.data.pid) {
                                addLog('info', name + ': new PID: ' + data.data.pid);
                            }
                        }
                    } else {
                        showToast('Error: ' + (data.error || 'Unknown'), 'error');
                        addLog('error', name + ' ' + action + ' failed: ' + (data.error || 'Unknown'));
                    }
                    // Reload status after delay
                    setTimeout(loadStatus, 2000);
                })
                .catch(function(e) {
                    showToast('Error: ' + e.message, 'error');
                    addLog('error', 'Request failed: ' + e.message);
                });
        }

        function handleAuthError(r) {
            if (r.status === 401 || r.status === 403) {
                showToast('Authorization required. Please log in first.', 'error');
                addLog('error', 'Not authorized (HTTP ' + r.status + ')');
                return true;
            }
            return false;
        }

        function refreshProcesses(name) {
            fetch(API_BASE + '/apps/' + name + '/processes', { method: 'POST' })
                .then(function(r) { if (handleAuthError(r)) return null; return r.json(); })
                .then(function(data) {
                    if (!data) return;
                    if (data.success) {
                        var d = data.data;
                        var msg = d.running
                            ? 'PID ' + d.pid + ', ' + d.total_processes + ' total (' + (d.child_pids || []).length + ' workers)'
                            : 'not running';
                        addLog('info', name + ' processes: ' + msg);
                        showToast(name + ': ' + msg, 'success');
                        setTimeout(loadStatus, 500);
                    } else {
                        showToast('Error: ' + (data.error || 'Unknown'), 'error');
                    }
                })
                .catch(function(e) { showToast('Error: ' + e.message, 'error'); });
        }

        function refreshVenvStatus(name) {
            fetch(API_BASE + '/apps/' + name + '/venv-status', { method: 'POST' })
                .then(function(r) { if (handleAuthError(r)) return null; return r.json(); })
                .then(function(data) {
                    if (!data) return;
                    if (data.success) {
                        addLog('info', name + ': venv ' + (data.data.exists ? (data.data.valid ? 'ready' : 'invalid') : 'missing') +
                            (data.data.size_mb ? ' (' + data.data.size_mb + ' MB)' : ''));
                        showToast(name + ' venv: ' + (data.data.exists ? (data.data.valid ? 'ready' : 'invalid') : 'missing'), 'success');
                        // Refresh full status to update the row
                        setTimeout(loadStatus, 500);
                    } else {
                        showToast('Error: ' + (data.error || 'Unknown'), 'error');
                    }
                })
                .catch(function(e) { showToast('Error: ' + e.message, 'error'); });
        }

        function confirmDeleteVenv(name) {
            showConfirm(
                'Delete .venv',
                'This will stop "' + name + '" (if running) and delete its .venv directory. The app cannot run until a new .venv is created.',
                function() { controlApp(name, 'clear-venv'); }
            );
        }

        function confirmCreateVenv(name) {
            showConfirm(
                'Create .venv',
                'This will create a fresh virtual environment for "' + name + '" and install its dependencies. The app will NOT be started automatically.',
                function() { controlApp(name, 'create-venv'); }
            );
        }

        function confirmRebuild(name) {
            showConfirm(
                'Rebuild .venv',
                'This will stop "' + name + '", delete .venv, create a fresh one, install dependencies, and restart the app. This may take a minute.',
                function() { controlApp(name, 'rebuild-venv'); }
            );
        }

        // =====================================================================
        // Initial load
        // =====================================================================
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', 'Admin dashboard loaded');
            loadStatus();
            loadConfig();

            // Auto-refresh every 30 seconds
            setInterval(loadStatus, 30000);
        });
    </script>
</body>
</html>
