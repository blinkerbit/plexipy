# PyRest Framework Docker Compose Configuration
# Single Container with Python + Nginx (Alpine-based)
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d --build      # Rebuild and start
#   docker-compose logs -f pyrest     # View logs
#   docker-compose down               # Stop all services
#
# Air-Gapped / Internal PyPI Proxy:
#   For environments without internet access, configure an internal PyPI proxy:
#   
#   Build with proxy:
#     docker-compose build --build-arg PIP_INDEX_URL=https://pypi.internal.company.com/simple/
#   
#   Or set environment variables below for runtime package installs (isolated apps)

version: '3.8'

services:
  # =========================================================================
  # Main PyRest Server with Embedded Nginx
  # Single Alpine container running both Python app and Nginx
  # =========================================================================
  pyrest:
    build:
      context: .
      dockerfile: Dockerfile
      # Uncomment for air-gapped builds with internal PyPI proxy:
      # args:
      #   PIP_INDEX_URL: https://pypi.internal.company.com/simple/
      #   PIP_TRUSTED_HOST: pypi.internal.company.com
    container_name: pyrest-main
    restart: unless-stopped
    ports:
      # Nginx (reverse proxy)
      - "80:80"
      - "443:443"
      # PyRest API (direct access - optional, can remove if only using nginx)
      - "8000:8000"
    environment:
      - PYREST_HOST=0.0.0.0
      - PYREST_PORT=8000
      - PYREST_DEBUG=false
      # -----------------------------------------------------------------------
      # Air-Gapped Environment: Uncomment for internal PyPI proxy
      # (uv automatically uses PIP_INDEX_URL - no separate config needed)
      # -----------------------------------------------------------------------
      # - PIP_INDEX_URL=https://pypi.internal.company.com/simple/
      # - PIP_TRUSTED_HOST=pypi.internal.company.com
      # -----------------------------------------------------------------------
      # Apps folder can be configured via environment variable (defaults to "apps" from config.json)
      # Set PYREST_APPS_FOLDER to use a different path (e.g., /custom/path/to/apps)
    volumes:
      # Mount apps folder (path configurable via PYREST_APPS_FOLDER env var or config.json)
      # Default: ./apps -> /app/apps (if WORKDIR is /app)
      # To use a different path, set PYREST_APPS_FOLDER env var and update this mount accordingly
      - ./apps:/app/apps
      # Mount config files
      - ./config.json:/app/config.json:ro
      - ./auth_config.json:/app/auth_config.json:ro
      # Nginx config output (for generated configs)
      - ./nginx:/app/nginx
      # SSL certificates (uncomment for HTTPS)
      # - ./nginx/ssl:/etc/nginx/ssl:ro
      # Logs
      - pyrest-logs:/app/logs
    networks:
      - pyrest-network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost/nginx-health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
  # =========================================================================
  # Example Isolated App: TM1 Data API
  # Uncomment to run as separate container (for scaling/isolation)
  # Note: When using unified container, isolated apps run inside pyrest container
  # =========================================================================
  # tm1data:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.isolated
  #     args:
  #       APP_NAME: tm1data
  #       APP_PORT: 8001
  #   container_name: pyrest-tm1data
  #   restart: unless-stopped
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     - PYREST_APP_NAME=tm1data
  #     - PYREST_APP_PORT=8001
  #     - PYREST_BASE_PATH=/pyrest
  #     - PYREST_AUTH_CONFIG=/app/auth_config.json
  #   volumes:
  #     - ./auth_config.json:/app/auth_config.json:ro
  #   networks:
  #     - pyrest-network
  #   depends_on:
  #     - pyrest

  # =========================================================================
  # Redis (Optional - for session storage / caching)
  # =========================================================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: pyrest-redis
  #   restart: unless-stopped
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - pyrest-network
  #   command: redis-server --appendonly yes

  # =============================================================================
  # Networks
  # =============================================================================
networks:
  pyrest-network:
    driver: bridge
    name: pyrest-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  pyrest-logs:
    name: pyrest-logs
  # redis-data:
  #   name: pyrest-redis-data
